- name: Get database status
  command: "{{ monetdb_prefix }}/bin/monetdb status {{ atraf_db }}"
  register: db_status
  failed_when: "'stderr' in db_status and db_status.stderr and not 'no such database' in db_status.stderr"
  changed_when: False

- name: Create database
  when: not db_status.stdout
  command: "{{ monetdb_prefix }}/bin/monetdb create {{ atraf_db }}"
  register: db_created

- name: Start database
  when: db_created.changed or not 'R' in db_status.stdout_lines[1].split()[1]
  command: "{{ monetdb_prefix }}/bin/monetdb start {{ atraf_db }}"

- name: Release database
  when: db_created.changed or 'L' in db_status.stdout_lines[1].split()[1]
  command: "{{ monetdb_prefix }}/bin/monetdb release {{ atraf_db }}"

- name: Get database details
  tags:
  - generate
  shell: "{{ monetdb_prefix }}/bin/monetdb status -l {{ atraf_db }} | sed -n -e 's/  connection uri: //p'"
  register: mapi_uri
  failed_when: not mapi_uri.stdout
  changed_when: False

- name: Figure out mapi uri
  tags:
  - generate
  set_fact:
    mapi_uri: "{{ mapi_uri.stdout }}"

- name: Partition the data
  tags:
  - generate
  set_fact:
    partitioning: "{{ lookup('pipe', 'python partition.py subsets/' + atraf_subset + '/inputs.txt ' + (atraf_slave_nodes or atraf_master_node)) }}"

- name: Create work directories
  tags:
  - generate
  file:
    path: "{{ item }}"
    state: directory
  with_items:
  - "{{ atraf_dir }}"
  - "{{ atraf_dir }}/sql"
  - "{{ atraf_data_dir }}"
  - "{{ atraf_answers_dir }}"

- name: Create .monetdb
  tags:
  - generate
  template:
    src: dot.monetdb.in
    dest: "{{ atraf_dir }}/.monetdb"

- name: Generate scripts
  tags:
  - generate
  template:
    src: "{{ item }}.in"
    dest: "{{ atraf_dir }}/{{ item }}"
    mode: a+x
  with_items:
  - collect.sh
  - check.sh
  - bench.py

- name: Generate schema
  tags:
  - generate
  template:
    src: schema.sql.in
    dest: "{{ atraf_schema_sql }}"
    mode: a+x

- name: Copy files
  tags:
  - generate
  synchronize:
    src: "{{item}}"
    dest: "{{atraf_dir}}"
  with_items:
  - sql

- name: Copy answers
  tags:
  - generate
  synchronize:
    src: "subsets/{{ atraf_subset }}/"
    dest: "{{atraf_answers_dir}}"

- name: Prepare data retrieval
  template:
    src: fetch-data.mk.in
    dest: "{{ atraf_data_dir }}/Makefile"

- name: Retrieve data
  command: make -C {{ atraf_data_dir }} -j{{ hostvars[inventory_hostname].get('ansible_processor_vcpus') or ansible_processor_cores }}
  register: retrieval_status
  changed_when: retrieval_status.rc == 0 and not "Nothing to be done for 'all'" in retrieval_status.stdout

- name: Drop existing schema
  tags:
  - load
  command: "{{ monetdb_prefix }}/bin/mclient -d {{ atraf_db }} -s 'DROP SCHEMA atraf'"
  environment:
    DOTMONETDBFILE: "{{ atraf_dir }}/.monetdb"

- name: Load database
  tags:
  - load
  - loadonly
  command: "{{ monetdb_prefix }}/bin/mclient -d {{ atraf_db }} {{ atraf_schema_sql }}"
  environment:
    DOTMONETDBFILE: "{{ atraf_dir }}/.monetdb"
