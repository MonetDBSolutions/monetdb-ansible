#!/bin/bash

DB="${1:-{{ atraf_db }}}"
REF="answers-$DB"
MCLIENT="$(cd "$HOME"; cd "{{monetdb_prefix }}/bin"; pwd)/mclient"


test -d "$REF" || die "Usage: $0 REF"

check() {
	local test="sql/$1.sql"
	local ref="$REF/$1.csv"
	dst="output.$1.csv"
	shift
	>&2 echo ":: $test"
	if ! "$MCLIENT" -d "$DB" -f csv "$@" > "$dst"
	then
		>&2 echo "Mclient failed"
		return 1
	fi
	if cmp "$ref" "$dst"
	then
		rm "$dst"
	else
		>&2 echo "Output differs: diff \"$ref\" \"$dst\""
		return 1
	fi
}

check rowcount -s 'select "Year" as "year", "Month" as "month", actual as rowcount from atraf.missing_rows order by "year", "month"'

for q in sql/q*.sql
do
        f=${q#sql/}
        n=${f%.sql}
        check $n $q
done
